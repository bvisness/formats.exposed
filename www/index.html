<!DOCTYPE html>
<head>
  <meta charset="utf-8">
</head>

<body>
  <script src="/odin.js"></script>
  <script>
    async function doit(data) {
      const odinWasm = new odin.WasmMemoryInterface();
      await odin.runWasm("/png.wasm", null, {}, odinWasm);

      function storeBytes(addr, value) {
        const dst = new Uint8Array(odinWasm.memory.buffer, addr, value.length);
        dst.set(value);
        return value.length;
      }

      const {
        alloc,
        parse,
        get_result,
        get_result_len,
        print_errors,
        debugcheck,
      } = odinWasm.exports;
      const inPtr = alloc(data.length);
      storeBytes(inPtr, data);
      const ok = parse();
      print_errors();
      if (!ok) {
        throw new Error("failed parse");
      }
      const result = odinWasm.loadBytes(get_result(), get_result_len());
      console.log("result", result);
      debugcheck();

      const dataView = new DataView(result.buffer, result.byteOffset, result.byteLength);
      const width = dataView.getInt32(0, true);
      const height = dataView.getInt32(4, true);
      const rgba = new Uint8ClampedArray(result).slice(8);

      window.canvas.width = width;
      window.canvas.height = height;
      window.canvas.style.width = `${width * 2}px`;
      window.canvas.style.height = `${height * 2}px`;

      const newImageData = new ImageData(rgba, width, height);
      const ctx = window.canvas.getContext("2d");
      ctx.putImageData(newImageData, 0, 0);
    }

    async function fileSelected(e) {
      const input = e.target;
      if (!input.files?.length) {
        return;
      }

      const file = input.files[0];
      const data = await file.bytes();
      await doit(data);
    }

    (async () => {
      const searchParams = new URL(window.location.toString()).searchParams;
      const initialFile = searchParams.get("file");
      if (initialFile) {
        const res = await fetch(initialFile);
        const bytes = await res.bytes();
        await doit(bytes);
      }
    })()
  </script>

  <div>
    <input
      id="fileinput"
      type="file"
      accept=".png"
      onchange="fileSelected(event)"
    >
  </div>
  <canvas id="canvas" width="8" height="8" style="width: 160px; height: 160px; image-rendering: crisp-edges"></canvas>
</body>

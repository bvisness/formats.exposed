<!DOCTYPE html>
<head>
  <meta charset="utf-8">
</head>

<body>
  <script src="/odin.js"></script>
  <script>
    async function doit(data) {
      const odinWasm = new odin.WasmMemoryInterface();
      await odin.runWasm("/png.wasm", null, {}, odinWasm);

      function storeBytes(addr, value) {
        const dst = new Uint8Array(odinWasm.memory.buffer, addr, value.length);
        dst.set(value);
        return value.length;
      }

      const {
        alloc,
        parse,
        get_result,
        get_result_len,
        print_errors,
        debugcheck,
      } = odinWasm.exports;
      const inPtr = alloc(data.length);
      storeBytes(inPtr, data);
      const ok = parse();
      print_errors();
      if (!ok) {
        throw new Error("failed parse");
      }
      const result = odinWasm.loadBytes(get_result(), get_result_len());
      console.log("result", result);
      debugcheck();

      // TODO
      const WIDTH = 8;
      const HEIGHT = 8;

      const newImageData = new ImageData(new Uint8ClampedArray(result), 8, 8); // TODO
      const ctx = window.canvas.getContext("2d");
      ctx.putImageData(newImageData, 0, 0);
    }

    async function fileSelected(e) {
      const input = e.target;
      if (!input.files?.length) {
        return;
      }

      const file = input.files[0];
      const data = await file.bytes();
      await doit(data);
    }
  </script>

  <div>
    <input
      id="fileinput"
      type="file"
      accept=".png"
      onchange="fileSelected(event)"
    >
  </div>
  <canvas id="canvas" width="8" height="8" style="width: 160px; height: 160px; image-rendering: crisp-edges"></canvas>
</body>
